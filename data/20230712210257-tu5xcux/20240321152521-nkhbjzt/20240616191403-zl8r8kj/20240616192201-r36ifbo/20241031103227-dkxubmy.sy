{"ID":"20241031103227-dkxubmy","Spec":"1","Type":"NodeDocument","Properties":{"id":"20241031103227-dkxubmy","title":"US3S2L6——切线空间下计算法线纹理贴图","type":"doc","updated":"20241104090749"},"Children":[{"ID":"20241031103227-a6td6nb","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241031103227-a6td6nb","updated":"20241102181415"},"Children":[{"Type":"NodeText","Data":"导入法线贴图资源"}]},{"ID":"20241101123940-q163lmk","Type":"NodeParagraph","Properties":{"id":"20241101123940-q163lmk","updated":"20241101124042"},"Children":[{"Type":"NodeText","Data":"对于法线贴图，它的纹理类型需要设置为 Normal Map"}]},{"ID":"20241101124106-ktvi9ug","Type":"NodeParagraph","Properties":{"id":"20241101124106-ktvi9ug","updated":"20241101124106"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241101124105-esyf0hz.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102181414-q0oj5gz","Type":"NodeBlockquote","Properties":{"id":"20241102181414-q0oj5gz","updated":"20241102181415"},"Children":[{"ID":"20241102122904-mz7hpq3","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102122904-mz7hpq3","updated":"20241102181415"},"Children":[{"Type":"NodeText","Data":"关键知识点补充"}]},{"ID":"20241102122904-pjq7ijc","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241102122904-pjq7ijc","updated":"20241102181415"},"Children":[{"ID":"20241102122904-lq1k75t","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241102122904-lq1k75t","updated":"20241102122904"},"Children":[{"ID":"20241102122904-45dq20z","Type":"NodeParagraph","Properties":{"id":"20241102122904-45dq20z","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"模型空间下的切线数据"}]},{"ID":"20241102122904-tdhntam","Type":"NodeParagraph","Properties":{"id":"20241102122904-tdhntam","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"模型数据中的切线数据为 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616115341-vk5ysnu","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"float4"},{"Type":"NodeText","Data":"​ 类型的（四维向量），其中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"w"},{"Type":"NodeText","Data":"​ 表示副切线的方向\n用法线和切线叉乘得到的副切线方向可能有两个（如下图的两个方向的灰色线），用切线数据中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"w"},{"Type":"NodeText","Data":"​ 与之相乘确定副切线方向"}]},{"ID":"20241102122904-iiopi3t","Type":"NodeParagraph","Properties":{"id":"20241102122904-iiopi3t","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"style":"width: 83px;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241030132052-rumfkif.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"width: 83px;\"}"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20241102122904-pgpbc78","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241102122904-pgpbc78","updated":"20241102122904"},"Children":[{"ID":"20241102122904-pspt3rk","Type":"NodeParagraph","Properties":{"id":"20241102122904-pspt3rk","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"Unity 当中的法线纹理类型"}]},{"ID":"20241102122904-tqi1poi","Type":"NodeSuperBlock","Properties":{"id":"20241102122904-tqi1poi","updated":"20241102122904"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20241102122904-9g3y31n","Type":"NodeParagraph","Properties":{"id":"20241102122904-9g3y31n","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"当我们把纹理类型设置为 "},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20230727173123-cf430vt","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"Normal map"},{"Type":"NodeText","Data":"（法线贴图）时，\n我们可以使用Unity提供的内置函数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnpackNormal"},{"Type":"NodeText","Data":"​ 来得到正确的法线方向。\n该函数内部不仅可以进行 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"法线分量 = 像素分量 \\times 2 - 1"},{"Type":"NodeText","Data":"的逆运算，\n还会进行解压运算（Unity 会根据不同平台对法线纹理进行压缩）"}]},{"ID":"20241102122904-kkui2kw","Type":"NodeParagraph","Properties":{"id":"20241102122904-kkui2kw","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241030132146-r99zcbn.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeSuperBlockCloseMarker"}]}]},{"ID":"20241102122904-ueui6bi","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20241102122904-ueui6bi","updated":"20241102122904"},"Children":[{"ID":"20241102122904-xu4ldvx","Type":"NodeParagraph","Properties":{"id":"20241102122904-xu4ldvx","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"法线纹理属性命名一般为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_BumpMap"},{"Type":"NodeText","Data":"​（凸块贴图），\n并声明一个我们还会声明一个名为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_BumpScale"},{"Type":"NodeText","Data":"​（凸块缩放)）的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"float"},{"Type":"NodeText","Data":"​ 属性，它主要用于控制凹凸程度"}]},{"ID":"20241102122904-o2s5qsg","Type":"NodeParagraph","Properties":{"id":"20241102122904-o2s5qsg","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"当它为 0 时，表示没有法线效果，法线的影响会被消除\n当它为 1 时，表示使用法线贴图中的原始法线信息，没有缩放\n我们可以根据实际需求调整它的值，来达到视觉上令人满意的效果"}]}]},{"ID":"20241102122904-5bhu1g5","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20241102122904-5bhu1g5","updated":"20241102122904"},"Children":[{"ID":"20241102122904-sljxu4m","Type":"NodeParagraph","Properties":{"id":"20241102122904-sljxu4m","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"如果使用的凹凸纹理不是法线纹理，而是高度纹理"}]},{"ID":"20241102122904-3lscj3u","Type":"NodeParagraph","Properties":{"id":"20241102122904-3lscj3u","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"我们需要进行如下设置："}]},{"ID":"20241102122904-ivpu79a","Type":"NodeParagraph","Properties":{"id":"20241102122904-ivpu79a","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"图片类型设置为 "},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20230727173123-cf430vt","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"Normal map"},{"Type":"NodeText","Data":"（法线贴图）并勾选 Create from Grayscale（从灰度创建）\n这样我们就可以把高度纹理当成切线空间下的法线纹理处理了"}]},{"ID":"20241102122904-xswytnx","Type":"NodeParagraph","Properties":{"id":"20241102122904-xswytnx","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"多出的参数分别为："}]},{"ID":"20241102122904-j57j3on","Type":"NodeSuperBlock","Properties":{"id":"20241102122904-j57j3on","updated":"20241102122904"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20241102122904-5dxtx3q","Type":"NodeParagraph","Properties":{"id":"20241102122904-5dxtx3q","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241030132905-ecpo0so.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102122904-w15k7pw","Type":"NodeList","ListData":{},"Properties":{"id":"20241102122904-w15k7pw","updated":"20241102122904"},"Children":[{"ID":"20241102122904-zss69ys","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102122904-zss69ys","updated":"20241102122904"},"Children":[{"ID":"20241102122904-n11erku","Type":"NodeParagraph","Properties":{"id":"20241102122904-n11erku","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"Bumpiness（颠簸值）：控制凹凸程度"}]}]},{"ID":"20241102122904-40h5mu3","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102122904-40h5mu3","updated":"20241102122904"},"Children":[{"ID":"20241102122904-6i1euo8","Type":"NodeParagraph","Properties":{"id":"20241102122904-6i1euo8","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"Filtering（过滤模式）：决定凹凸程度的算法"}]},{"ID":"20241102122904-2q4bd3p","Type":"NodeParagraph","Properties":{"id":"20241102122904-2q4bd3p","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241030133228-h53ar1l.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102122904-xdvjy24","Type":"NodeList","ListData":{},"Properties":{"id":"20241102122904-xdvjy24","updated":"20241102122904"},"Children":[{"ID":"20241102122904-sccp52t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102122904-sccp52t","updated":"20241102122904"},"Children":[{"ID":"20241102122904-bp3slgd","Type":"NodeParagraph","Properties":{"id":"20241102122904-bp3slgd","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"Sharp：滤波生成法线"}]}]},{"ID":"20241102122904-2dksgn4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102122904-2dksgn4","updated":"20241102122904"},"Children":[{"ID":"20241102122904-a5skwst","Type":"NodeParagraph","Properties":{"id":"20241102122904-a5skwst","updated":"20241102122904"},"Children":[{"Type":"NodeText","Data":"Smooth：平滑的生成法线"}]}]}]}]}]},{"Type":"NodeSuperBlockCloseMarker"}]}]}]},{"Type":"NodeBlockquoteMarker","Data":"\u003e"}]},{"ID":"20241101124112-5fc7bus","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20241101124112-5fc7bus","updated":"20241102181310"},"Children":[{"Type":"NodeText","Data":"在切线空间下计算实现法线纹理Shader"}]},{"ID":"20241102180827-plhgcw4","Type":"NodeParagraph","Properties":{"id":"20241102180827-plhgcw4","updated":"20241102180827"},"Children":[{"Type":"NodeText","Data":"主要思路："}]},{"ID":"20241102180827-386qyqc","Type":"NodeList","ListData":{},"Properties":{"id":"20241102180827-386qyqc","updated":"20241102181310"},"Children":[{"ID":"20241102180827-xpkcr2e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102180827-xpkcr2e","updated":"20241102181119"},"Children":[{"ID":"20241102180827-ijo5cd5","Type":"NodeParagraph","Properties":{"id":"20241102180827-ijo5cd5","updated":"20241102181119"},"Children":[{"Type":"NodeText","Data":"在顶点着色器中计算模型空间到切换空间的变换矩阵，将光线方向和观察方向通过变换矩阵转换为切线空间下的"}]}]},{"ID":"20241102180827-ezoyje9","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102180827-ezoyje9","updated":"20241102181310"},"Children":[{"ID":"20241102180827-se4vq1f","Type":"NodeParagraph","Properties":{"id":"20241102180827-se4vq1f","updated":"20241102181310"},"Children":[{"Type":"NodeText","Data":"在片元着色器中对法线纹理采样，得到模型法线数据，结合之前得到的法线，光线方向和观察方向，通过光照模型计算光照"}]}]}]},{"ID":"20241101124116-ribs1no","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241101124116-ribs1no","updated":"20241102133055"},"Children":[{"Type":"NodeText","Data":"Shader 属性相关"}]},{"ID":"20241102120132-1kscanh","Type":"NodeSuperBlock","Properties":{"id":"20241102120132-1kscanh","updated":"20241102133055"},"Children":[{"Type":"NodeSuperBlockOpenMarker"},{"Type":"NodeSuperBlockLayoutMarker","Data":"col"},{"ID":"20241102115836-sz9c9fa","Type":"NodeList","ListData":{},"Properties":{"id":"20241102115836-sz9c9fa","style":"width: 33%; flex: 0 0 auto;","updated":"20241102133055"},"Children":[{"ID":"20241102115847-nttq16d","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115847-nttq16d","updated":"20241102115847"},"Children":[{"ID":"20241102115847-ffrs920","Type":"NodeParagraph","Properties":{"id":"20241102115847-ffrs920","updated":"20241102115847"},"Children":[{"Type":"NodeText","Data":"漫反射颜色\n"}]}]},{"ID":"20241102115848-1ekjjji","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115848-1ekjjji","updated":"20241102115848"},"Children":[{"ID":"20241102115848-7c9sgy3","Type":"NodeParagraph","Properties":{"id":"20241102115848-7c9sgy3","updated":"20241102115848"},"Children":[{"Type":"NodeText","Data":"单张纹理\n"}]}]},{"ID":"20241102115849-63qovwg","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115849-63qovwg","updated":"20241102115849"},"Children":[{"ID":"20241102115849-tqygfcq","Type":"NodeParagraph","Properties":{"id":"20241102115849-tqygfcq","updated":"20241102115849"},"Children":[{"Type":"NodeText","Data":"法线纹理\n"}]}]},{"ID":"20241102115850-iy468ln","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115850-iy468ln","updated":"20241102133055"},"Children":[{"ID":"20241102115850-lcsf3ke","Type":"NodeParagraph","Properties":{"id":"20241102115850-lcsf3ke","updated":"20241102133055"},"Children":[{"Type":"NodeText","Data":"凹凸程度（一般使用 0"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"1 即可）"}]}]},{"ID":"20241102115850-voadqbt","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115850-voadqbt","updated":"20241102115850"},"Children":[{"ID":"20241102115850-ugz92fu","Type":"NodeParagraph","Properties":{"id":"20241102115850-ugz92fu","updated":"20241102115850"},"Children":[{"Type":"NodeText","Data":"高光反射颜色\n"}]}]},{"ID":"20241102115851-8kixkoz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102115851-8kixkoz","updated":"20241102115851"},"Children":[{"ID":"20241102115851-zox3xev","Type":"NodeParagraph","Properties":{"id":"20241102115851-zox3xev","updated":"20241102115851"},"Children":[{"Type":"NodeText","Data":"光泽度"}]}]}]},{"ID":"20241102120123-oo4u2gi","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102120123-oo4u2gi","style":"line-height: 22px;","updated":"20241102133028"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"Properties\n{\n    _MainColor(\"MainColor\", Color) = (1, 1, 1, 1)\t\t\t//漫反射颜色\n    _MainTex(\"MainTex\", 2D) = \"\"{}\t\t\t\t\t\t\t//主要纹理贴图\n    _BumpMap(\"BumpMap\", 2D) = \"\"{}\t\t\t\t\t\t\t//凹凸纹理贴图\n    _BumpScale(\"BumpScale\", Range(0, 1)) = 1\t\t\t\t//凹凸程度\n    _SpecularColor(\"SpecularColor\", Color) = (1, 1, 1, 1)\t//高光反射颜色\n    _SpecularNum(\"SpecularNum\", Range(0, 20)) = 18\t\t\t//光泽度\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"Type":"NodeSuperBlockCloseMarker"}]},{"ID":"20241102120250-edf42i6","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102120250-edf42i6","updated":"20241102122232"},"Children":[{"Type":"NodeText","Data":"结构体相关"}]},{"ID":"20241102120404-37q5wqs","Type":"NodeList","ListData":{},"Properties":{"id":"20241102120404-37q5wqs","updated":"20241102122232"},"Children":[{"ID":"20241102120406-9s5z30v","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102120406-9s5z30v","updated":"20241102120603"},"Children":[{"ID":"20241102120406-p4sll4w","Type":"NodeParagraph","Properties":{"id":"20241102120406-p4sll4w","updated":"20241102120435"},"Children":[{"Type":"NodeText","Data":"传入顶点着色器的结构体"}]},{"ID":"20241102120448-dlpqyt8","Type":"NodeParagraph","Properties":{"id":"20241102120448-dlpqyt8","updated":"20241102120603"},"Children":[{"Type":"NodeText","Data":"可以直接使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnityCG.cginc"},{"Type":"NodeText","Data":"​ 中的 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616182612-1w0c0lf","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"appdata_full"},{"Type":"NodeText","Data":"​\n其中包含了我们需要的顶点、法线、切线、纹理坐标相关数据"}]},{"ID":"20241102120950-8qw0o4m","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102120950-8qw0o4m","style":"line-height: 22px;","updated":"20241102121105"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"// ​UnityCG.cginc​内定义，无需自己再定义\nstruct appdata_full {\n    float4 vertex : POSITION;\t\t//模型空间中的顶点位置\n    float4 tangent : TANGENT;\t\t//顶点切线\n    float3 normal : NORMAL;\t\t\t//顶点法线\n    float4 texcoord : TEXCOORD0;\t//第一组纹理坐标\n    float4 texcoord1 : TEXCOORD1;\t//第二组纹理坐标\n    float4 texcoord2 : TEXCOORD2;\t//第三组纹理坐标\n    float4 texcoord3 : TEXCOORD3;\t//第四组纹理坐标\n    fixed4 color : COLOR;\t\t\t//顶点颜色\n    UNITY_VERTEX_INPUT_INSTANCE_ID\n};\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]},{"ID":"20241102120436-c6h6vmy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241102120436-c6h6vmy","updated":"20241102122232"},"Children":[{"ID":"20241102120436-mg0xmxj","Type":"NodeParagraph","Properties":{"id":"20241102120436-mg0xmxj","updated":"20241102120447"},"Children":[{"Type":"NodeText","Data":"传入片元着色器的结构体"}]},{"ID":"20241102120456-aeltyps","Type":"NodeParagraph","Properties":{"id":"20241102120456-aeltyps","updated":"20241102121714"},"Children":[{"Type":"NodeText","Data":"需要自定义一个结构体，其中包含 裁剪空间下坐标、uv坐标、相对于切线空间下的光的方向、视角的方向"}]},{"ID":"20241102121111-ml8yvwl","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102121111-ml8yvwl","style":"line-height: 22px;","updated":"20241102122232"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"struct v2f\n{\n    float4 pos: SV_POSITION;\n    //float2 uvTex: TEXCOORD0;\n    //float2 uvBump: TEXCOORD1; //可以使用两个float2来分别存储主要纹理的uv和法线纹理的uv\n    float4 uv: TEXCOORD0;       //可以使用一个float4来同时存储主要纹理的uv（xy存储）和法线纹理的uv（zw存储）\n    float3 lightDir: TEXCOORD1; //相对于切线空间下的光的方向\n    float3 viewDir: TEXCOORD2;  //相对于切线空间下的视角方向\n};\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}]},{"ID":"20241102122031-tqhqxyq","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102122031-tqhqxyq","updated":"20241102182850"},"Children":[{"Type":"NodeText","Data":"顶点着色器回调函数内容"}]},{"ID":"20241102124237-zp96ijm","Type":"NodeParagraph","Properties":{"id":"20241102124237-zp96ijm","updated":"20241102182850"},"Children":[{"Type":"NodeText","Data":"执行步骤："}]},{"ID":"20241102122042-5nmicmn","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241102122042-5nmicmn","updated":"20241102125037"},"Children":[{"ID":"20241102122102-21qgakd","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241102122102-21qgakd","updated":"20241102122102"},"Children":[{"ID":"20241102122102-8m5g4zq","Type":"NodeParagraph","Properties":{"id":"20241102122102-8m5g4zq","updated":"20241102122102"},"Children":[{"Type":"NodeText","Data":"顶点坐标模型转裁剪"}]}]},{"ID":"20241102122102-s71yuid","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241102122102-s71yuid","updated":"20241102122102"},"Children":[{"ID":"20241102122102-njf0qw0","Type":"NodeParagraph","Properties":{"id":"20241102122102-njf0qw0","updated":"20241102124250"},"Children":[{"Type":"NodeText","Data":"单张纹理 和 法线纹理 的UV坐标缩放偏移计算"}]}]},{"ID":"20241102122102-0apzha4","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20241102122102-0apzha4","updated":"20241102125031"},"Children":[{"ID":"20241102122102-vz1hw6h","Type":"NodeParagraph","Properties":{"id":"20241102122102-vz1hw6h","updated":"20241102122102"},"Children":[{"Type":"NodeText","Data":"副切线计算\n"}]},{"ID":"20241102122106-5c6szh6","Type":"NodeParagraph","Properties":{"id":"20241102122106-5c6szh6","updated":"20241102124618"},"Children":[{"Type":"NodeText","Data":"用模型空间中的法线和切线进行叉乘，再乘以切线中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"w"},{"Type":"NodeText","Data":"​（确定副切线方向）"}]},{"ID":"20241102124620-efduit9","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102124620-efduit9","style":"line-height: 22px;","updated":"20241102125031"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"// 假设v.tangent是切线（float4类型），v.normal是法线，（float3类型）\nfloat3 binormal = cross(normalize(v.tangent), normalize(v.normal)) * v.tangent.w;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]},{"ID":"20241102122102-fda9y8m","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20241102122102-fda9y8m","updated":"20241102125037"},"Children":[{"ID":"20241102122102-jmg3sr2","Type":"NodeParagraph","Properties":{"id":"20241102122102-jmg3sr2","updated":"20241102122102"},"Children":[{"Type":"NodeText","Data":"构建模型空间到切线空间的变换矩阵\n"}]},{"ID":"20241102122122-up3s0xl","Type":"NodeParagraph","Properties":{"id":"20241102122122-up3s0xl","updated":"20241102125008"},"Children":[{"Type":"NodeText","Data":"模型空间到切线空间的变换矩阵为："},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"\\begin{pmatrix} _esc_newline_  — \u0026 切线 \u0026 — \\\\_esc_newline_  — \u0026 副切线 \u0026 — \\\\_esc_newline_  — \u0026 法线 \u0026 — \\\\_esc_newline_\\end{pmatrix}"}]},{"ID":"20241102124952-r17o3ni","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102124952-r17o3ni","style":"line-height: 22px;","updated":"20241102125037"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"// 假设v.tangent是切线（float4类型），v.normal是法线（float3类型）\n// 计算副切线\nfloat3 binormal = cross(normalize(v.tangent), normalize(v.normal)) * v.tangent.w;\n// 得到模型空间到切线空间的转换矩阵\nfloat3x3 rotation = float3x3(\n    v.tangent.xyz,  //切线\n    binormal,       //副切线\n    v.normal,       //法线\n)\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]},{"ID":"20241102122102-jagil50","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20241102122102-jagil50","updated":"20241102122102"},"Children":[{"ID":"20241102122102-894zkz7","Type":"NodeParagraph","Properties":{"id":"20241102122102-894zkz7","updated":"20241102124329"},"Children":[{"Type":"NodeText","Data":"将光照方向和视角方向转换到模型空间（利用 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616182923-2366ixd","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"ObjSpaceLightDir"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616182923-8ofh3l4","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"ObjSpaceViewDir"},{"Type":"NodeText","Data":"​ 内置函数）"}]}]},{"ID":"20241102122102-5gkhxmr","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Ni4=","Num":6},"Properties":{"id":"20241102122102-5gkhxmr","updated":"20241102122102"},"Children":[{"ID":"20241102122102-lj1gohf","Type":"NodeParagraph","Properties":{"id":"20241102122102-lj1gohf","updated":"20241102122102"},"Children":[{"Type":"NodeText","Data":"将光照方向和视角方向转换到切线空间（利用变换矩阵进行乘法运算）"}]}]}]},{"ID":"20241102124226-8bp0dvh","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102124226-8bp0dvh","style":"line-height: 22px;","updated":"20241102132755"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"// 注：appdata_full不需要自定义，#include \"UnityCG.cginc\"即可使用，这里仅用于展示其成员\nstruct appdata_full {\n    float4 vertex : POSITION;\t\t//模型空间中的顶点位置\n    float4 tangent : TANGENT;\t\t//顶点切线\n    float3 normal : NORMAL;\t\t\t//顶点法线\n    float4 texcoord : TEXCOORD0;\t//第一组纹理坐标\n    //...\n};\n\nstruct v2f\n{\n    float4 pos: SV_POSITION;\n    float4 uv: TEXCOORD0;       //xy存储主要纹理的uv，zw存储法线纹理的uv\n    float3 lightDir: TEXCOORD1; //相对于切线空间下的光的方向\n    float3 viewDir: TEXCOORD2;  //相对于切线空间下的视角方向\n};\n\nfloat4 _MainTex_ST;     //颜色纹理的缩放和平移\nfloat4 _BumpMap_ST;     //法线纹理的缩放和平移\n\nv2f vert (appdata_full v)\n{\n    v2f data;\n  \n    data.pos = UnityObjectToClipPos(v.vertex);  //计算裁剪空间下顶点坐标\n    // 分别计算主纹理和法线纹理的缩放平移\n    data.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;\n    data.uv.zw = v.texcoord.xy * _BumpMap_ST.xy + _BumpMap_ST.zw;\n\n    // 计算副切线\n    float3 binormal = cross(normalize(v.tangent), normalize(v.normal)) * v.tangent.w;\n    // 得到模型空间到切线空间的转换矩阵\n    float3x3 rotation = float3x3(\n        v.tangent.xyz,  //切线\n        binormal,       //副切线\n        v.normal        //法线\n    );\n  \n    data.lightDir = mul(rotation, ObjSpaceLightDir(v.vertex));   // 切线空间下的光的方向\n    data.viewDir = mul(rotation, ObjSpaceViewDir(v.vertex));    // 切线空间下的视角方向\n\n    return data;\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241102125056-3ewwog2","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102125056-3ewwog2","updated":"20241102184945"},"Children":[{"Type":"NodeText","Data":"片元着色器回调函数内容"}]},{"ID":"20241102182853-zkqzeri","Type":"NodeParagraph","Properties":{"id":"20241102182853-zkqzeri","updated":"20241102182856"},"Children":[{"Type":"NodeText","Data":"执行步骤："}]},{"ID":"20241102125157-05rnsib","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241102125157-05rnsib","updated":"20241102184945"},"Children":[{"ID":"20241102125217-2g4812c","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241102125217-2g4812c","updated":"20241102125231"},"Children":[{"ID":"20241102125217-igmopwa","Type":"NodeParagraph","Properties":{"id":"20241102125217-igmopwa","updated":"20241102125231"},"Children":[{"Type":"NodeText","Data":"取出法线贴图中的法线信息（利用纹理采样函数 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616175909-rwnovje","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"tex2D"},{"Type":"NodeText","Data":"​ ）"}]}]},{"ID":"20241102125217-hdfn76a","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241102125217-hdfn76a","updated":"20241102184945"},"Children":[{"ID":"20241102125217-18ya13q","Type":"NodeParagraph","Properties":{"id":"20241102125217-18ya13q","updated":"20241102184945"},"Children":[{"Type":"NodeText","Data":"利用内置的 "},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20241102181425-2sro4b5","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"UnpackNormal"},{"Type":"NodeText","Data":"​ 函数对法线信息进行逆运算以及可能的解压"}]}]},{"ID":"20241102125217-ih081iw","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20241102125217-ih081iw","updated":"20241102125303"},"Children":[{"ID":"20241102125217-4hfeybt","Type":"NodeParagraph","Properties":{"id":"20241102125217-4hfeybt","updated":"20241102125303"},"Children":[{"Type":"NodeText","Data":"用得到的切线空间的法线数据 乘以 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"BumpScale"},{"Type":"NodeText","Data":"​ 来控制凹凸程度"}]}]},{"ID":"20241102125217-ciqkxdn","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NC4=","Num":4},"Properties":{"id":"20241102125217-ciqkxdn","updated":"20241102125217"},"Children":[{"ID":"20241102125217-yhoheh6","Type":"NodeParagraph","Properties":{"id":"20241102125217-yhoheh6","updated":"20241102125217"},"Children":[{"Type":"NodeText","Data":"得到单张纹理颜色和漫反射颜色的叠加颜色"}]}]},{"ID":"20241102125217-r7xcnrb","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"NS4=","Num":5},"Properties":{"id":"20241102125217-r7xcnrb","updated":"20241102125537"},"Children":[{"ID":"20241102125217-ju7zuhp","Type":"NodeParagraph","Properties":{"id":"20241102125217-ju7zuhp","updated":"20241102125537"},"Children":[{"Type":"NodeText","Data":"用切线空间下的光方向、视角方向、法线方向，进行 "},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20240706225151-9ajnfwg","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"Blinn Phong光照模型"},{"Type":"NodeText","Data":" 计算"}]}]}]},{"ID":"20241102125314-hku0alu","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102125314-hku0alu","style":"line-height: 22px;","updated":"20241102132840"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"struct v2f\n{\n    float4 pos: SV_POSITION;\n    //float2 uvTex: TEXCOORD0;\n    //float2 uvBump: TEXCOORD1; //可以使用两个float2来分别存储主要纹理的uv和法线纹理的uv\n    float4 uv: TEXCOORD0;       //可以使用一个float4来同时存储主要纹理的uv（xy存储）和法线纹理的uv（zw存储）\n    float3 lightDir: TEXCOORD1; //相对于切线空间下的光的方向\n    float3 viewDir: TEXCOORD2;  //相对于切线空间下的视角方向\n};\n\nfloat4 _MainColor;      //漫反射颜色\nsampler2D _MainTex;     //颜色纹理\nsampler2D _BumpMap;     //法线纹理\nfloat _BumpScale;       //凹凸程度\nfloat4 _SpecularColor;  //高光颜色\nfixed _SpecularNum;     //光泽度\n\nfixed4 frag (v2f i) : SV_Target\n{\n    float4 packedNormal = tex2D(_BumpMap, i.uv.zw);     // 获取法线纹理的颜色数据\n    float3 tangentNormal = UnpackNormal(packedNormal);  // 将颜色数据逆运算并解压缩，得到切线空间下法线数据\n    tangentNormal *= _BumpScale;                        // 将法线数据乘以凹凸系数\n\n    // 计算带纹理颜色的BlinnPhong光照计算，这里使用已经计算好的切线数据\n    fixed3 albedo = tex2D(_MainTex, i.uv.xy).rgb * _MainColor.rgb;  // 反射率\n\n    // 漫反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向，注意！这里的 tangentNormal 无需归一化\n    fixed3 lambertColor = _LightColor0.rgb * albedo.rgb * max(0, dot(tangentNormal, normalize(i.lightDir)));\n    // 高光反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向\n    float3 halfA = normalize(normalize(i.viewDir) + normalize(i.lightDir));     // 半角向量\n    fixed3 specularColor = _LightColor0.rgb * _SpecularColor.rgb * pow(max(0, dot(tangentNormal, halfA)), _SpecularNum);\n    // 最终颜色计算\n    fixed3 color = UNITY_LIGHTMODEL_AMBIENT.rgb * albedo + lambertColor + specularColor;\n\n    return fixed4(color.rgb, 1);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241102132854-n1ld4ee","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102132854-n1ld4ee","updated":"20241104090749"},"Children":[{"Type":"NodeText","Data":"代码示例"}]},{"ID":"20241102132930-7h19rwf","Type":"NodeParagraph","Properties":{"id":"20241102132930-7h19rwf","updated":"20241102132936"},"Children":[{"Type":"NodeText","Data":"完整 Shader 代码如下："}]},{"ID":"20241102132937-86iqj6d","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102132937-86iqj6d","style":"line-height: 22px;","updated":"20241102133251"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"Shader \"TeachShader/Lesson51\"\n{\n    Properties\n    {\n        _MainColor(\"MainColor\", Color) = (1, 1, 1, 1)\n        _MainTex(\"MainTex\", 2D) = \"\"{}\n        _BumpMap(\"BumpMap\", 2D) = \"\"{}\n        _BumpScale(\"BumpScale\", Range(0, 1)) = 1\n        _SpecularColor(\"SpecularColor\", Color) = (1, 1, 1, 1)\n        _SpecularNum(\"SpecularNum\", Range(0, 20)) = 18\n    }\n    SubShader\n    {\n        Pass\n        {\n            Tags { \"LightMode\" = \"ForwardBase\" }\n\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n\n            #include \"UnityCG.cginc\"\n            #include \"Lighting.cginc\"\n\n            struct v2f\n            {\n                float4 pos: SV_POSITION;\n                //float2 uvTex: TEXCOORD0;\n                //float2 uvBump: TEXCOORD1; //可以使用两个float2来分别存储主要纹理的uv和法线纹理的uv\n                float4 uv: TEXCOORD0;       //可以使用一个float4来同时存储主要纹理的uv（xy存储）和法线纹理的uv（zw存储）\n                float3 lightDir: TEXCOORD1; //相对于切线空间下的光的方向\n                float3 viewDir: TEXCOORD2;  //相对于切线空间下的视角方向\n            };\n\n            float4 _MainColor;      //漫反射颜色\n            sampler2D _MainTex;     //颜色纹理\n            float4 _MainTex_ST;     //颜色纹理的缩放和平移\n            sampler2D _BumpMap;     //法线纹理\n            float4 _BumpMap_ST;     //法线纹理的缩放和平移\n            float _BumpScale;       //凹凸程度\n            float4 _SpecularColor;  //高光颜色\n            fixed _SpecularNum;     //光泽度\n\n            v2f vert (appdata_full v)\n            {\n                v2f data;\n              \n                data.pos = UnityObjectToClipPos(v.vertex);  //计算裁剪空间下顶点坐标\n                // 分别计算主纹理和法线纹理的缩放平移\n                data.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;\n                data.uv.zw = v.texcoord.xy * _BumpMap_ST.xy + _BumpMap_ST.zw;\n\n                // 计算副切线\n                float3 binormal = cross(normalize(v.tangent), normalize(v.normal)) * v.tangent.w;\n                // 得到模型空间到切线空间的转换矩阵\n                float3x3 rotation = float3x3(\n                    v.tangent.xyz,  //切线\n                    binormal,       //副切线\n                    v.normal        //法线\n                );\n              \n                data.lightDir = mul(rotation, ObjSpaceLightDir(v.vertex));   // 切线空间下的光的方向\n                data.viewDir = mul(rotation, ObjSpaceViewDir(v.vertex));    // 切线空间下的视角方向\n\n                return data;\n            }\n\n            fixed4 frag (v2f i) : SV_Target\n            {\n                float4 packedNormal = tex2D(_BumpMap, i.uv.zw);     // 获取法线纹理的颜色数据\n                float3 tangentNormal = UnpackNormal(packedNormal);  // 将颜色数据逆运算并解压缩，得到切线空间下法线数据\n                tangentNormal *= _BumpScale;                        // 将法线数据乘以凹凸系数\n\n                // 计算带纹理颜色的BlinnPhong光照计算，这里使用已经计算好的切线数据\n                fixed3 albedo = tex2D(_MainTex, i.uv.xy).rgb * _MainColor.rgb;  // 反射率\n\n                // 漫反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向，注意！这里的 tangentNormal 无需归一化\n                fixed3 lambertColor = _LightColor0.rgb * albedo.rgb * max(0, dot(tangentNormal, normalize(i.lightDir)));\n                // 高光反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向\n                float3 halfA = normalize(normalize(i.viewDir) + normalize(i.lightDir));     // 半角向量\n                fixed3 specularColor = _LightColor0.rgb * _SpecularColor.rgb * pow(max(0, dot(tangentNormal, halfA)), _SpecularNum);\n                // 最终颜色计算\n                fixed3 color = UNITY_LIGHTMODEL_AMBIENT.rgb * albedo + lambertColor + specularColor;\n\n                return fixed4(color.rgb, 1);\n            }\n            ENDCG\n        }\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241102133317-r805uo9","Type":"NodeParagraph","Properties":{"id":"20241102133317-r805uo9","updated":"20241102133401"},"Children":[{"Type":"NodeText","Data":"显示效果（左图为不使用法线贴图的方块，右图为使用法线贴图的方块）："}]},{"ID":"20241102133433-uaseh4g","Type":"NodeParagraph","Properties":{"id":"20241102133433-uaseh4g","updated":"20241102133433"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241102133433-4ajw0zx.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102133404-53pulhf","Type":"NodeParagraph","Properties":{"id":"20241102133404-53pulhf","updated":"20241102133606"},"Children":[{"Type":"NodeText","Data":"可见，使用法线纹理贴图的模型，虽然实际上没有做凹凸面，但是通过法线影响光照，通过光线模拟出了凹凸感"}]},{"ID":"20241102133457-6dh71ua","Type":"NodeBlockquote","Properties":{"id":"20241102133457-6dh71ua","updated":"20241102213140"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241102213130-fe8dgsf","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241102213130-fe8dgsf","updated":"20241102213140"},"Children":[{"Type":"NodeText","Data":"修改凹凸系数的计算方式，让法线系数不影响光照"}]},{"ID":"20241102213130-vaikg37","Type":"NodeParagraph","Properties":{"id":"20241102213130-vaikg37","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"目前的 Shader 写法中，凹凸系数 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"BumpScale"},{"Type":"NodeText","Data":"​ 会影响光照，凹凸系数越小，光照越暗"}]},{"ID":"20241102213130-h09zstz","Type":"NodeParagraph","Properties":{"id":"20241102213130-h09zstz","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"style":"width: 267px;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241102211004-wpcr4sr.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"width: 267px;\"}"},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102213130-drxnyia","Type":"NodeParagraph","Properties":{"id":"20241102213130-drxnyia","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"我们目前这种直接让 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"法线 \\times 凹凸系数"},{"Type":"NodeText","Data":" 的计算方式，并不是一个标准算法\n因为当凹凸系数趋近于 0 时，会影响光照模型的计算（法线也趋于0了，导致计算出来的颜色是偏黑的）"}]},{"ID":"20241102213130-ejfy4ev","Type":"NodeParagraph","Properties":{"id":"20241102213130-ejfy4ev","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"为了让凹凸系数不影响光的效果，有一种专门的算法"}]},{"ID":"20241102213130-z495x84","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241102213130-z495x84","updated":"20241102213130"},"Children":[{"ID":"20241102213130-e47s25h","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241102213130-e47s25h","updated":"20241102213130"},"Children":[{"ID":"20241102213130-nojys6f","Type":"NodeParagraph","Properties":{"id":"20241102213130-nojys6f","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"只让法线中的 xy 乘以凹凸系数"}]},{"ID":"20241102213130-7oadda8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102213130-7oadda8","style":"line-height: 22px;","updated":"20241102213130"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"tangentNormal.xy *= _BumpScale;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]},{"ID":"20241102213130-5wr8gxd","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241102213130-5wr8gxd","updated":"20241102213130"},"Children":[{"ID":"20241102213130-dqy1hd0","Type":"NodeParagraph","Properties":{"id":"20241102213130-dqy1hd0","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"同时保证法线为单位向量（让法线不会为0，而是趋近于顶点法线）"}]},{"ID":"20241102213130-26m64us","Type":"NodeParagraph","Properties":{"id":"20241102213130-26m64us","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"若要让法线在 xy 乘以凹凸系数后还要保持为单位向量，就需要让 z 分量进行改变\n根据单位向量的性质可得："}]},{"ID":"20241102213130-jkbn104","Type":"NodeMathBlock","Properties":{"id":"20241102213130-jkbn104","updated":"20241102213130"},"Children":[{"Type":"NodeMathBlockOpenMarker"},{"Type":"NodeMathBlockContent","Data":"\\because (x,y,z)为单位向量 \\\\\n\\therefore x^2 + y^2 + z^2 = 1 \\\\\n\\therefore z^2 = 1 - (x^2 + y^2) \\\\\n\\therefore z = \\sqrt{1 - (x^2 + y^2)}"},{"Type":"NodeMathBlockCloseMarker"}]},{"ID":"20241102213130-h7nuscn","Type":"NodeParagraph","Properties":{"id":"20241102213130-h7nuscn","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"又因为 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"x^2 + y^2 = (x,y) \\cdot (x,y)"},{"Type":"NodeText","Data":"，因此代码内可实现为："}]},{"ID":"20241102213130-iwfkphc","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102213130-iwfkphc","style":"line-height: 22px;","updated":"20241102213130"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"tangentNormal.z = sqrt(1.0 - saturate(dot(tangentNormal.xy, tangentNormal.xy)));\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241102213130-vj68mqc","Type":"NodeParagraph","Properties":{"id":"20241102213130-vj68mqc","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"其中，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"saturate"},{"Type":"NodeText","Data":"​ 函数是保证计算结果在 0"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"1 之间的"}]}]}]},{"ID":"20241102213130-qlqi3w3","Type":"NodeParagraph","Properties":{"id":"20241102213130-qlqi3w3","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"通过这样的计算，当凹凸系数在 0~1 之间变化时，会保证法线为单位向量，这样就不会影响光照表现了"}]},{"ID":"20241102213130-ihxa9xd","Type":"NodeBlockquote","Properties":{"id":"20241102213130-ihxa9xd","style":"background-color: var(--b3-card-warning-background); color: var(--b3-card-warning-color);","updated":"20241102213130"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241102213130-gutzx1e","Type":"NodeParagraph","Properties":{"id":"20241102213130-gutzx1e","updated":"20241102213130"},"Children":[{"Type":"NodeText","Data":"注意：这种算法并不是来自真实的物理规律，"},{"Type":"NodeTextMark","TextMarkType":"u","TextMarkTextContent":"只是为了 “看起来正常”"}]}]}]},{"ID":"20241102213140-pfjwbkn","Type":"NodeParagraph","Properties":{"id":"20241102213140-pfjwbkn","updated":"20241102213147"},"Children":[{"Type":"NodeText","Data":"因此，根据以上规则，片元着色器的 Shader 代码修改为："}]},{"ID":"20241102213131-gjbyx6t","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241102213131-gjbyx6t","style":"line-height: 22px;","updated":"20241102213323"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"fixed4 frag (v2f i) : SV_Target\n{\n    float4 packedNormal = tex2D(_BumpMap, i.uv.zw);     // 获取法线纹理的颜色数据\n    float3 tangentNormal = UnpackNormal(packedNormal);  // 将颜色数据逆运算并解压缩，得到切线空间下法线数据\n    // 将法线数据的xy乘以凹凸系数，根据xy修正z，避免凹凸系数影响光照亮度\n    tangentNormal.xy *= _BumpScale;                 \n    tangentNormal.z = sqrt(1.0 - saturate(dot(tangentNormal.xy, tangentNormal.xy)));\n\n    // 计算带纹理颜色的BlinnPhong光照计算，这里使用已经计算好的切线数据\n    fixed3 albedo = tex2D(_MainTex, i.uv.xy).rgb * _MainColor.rgb;  // 反射率\n\n    // 漫反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向，注意！这里的 tangentNormal 无需归一化\n    fixed3 lambertColor = _LightColor0.rgb * albedo.rgb * max(0, dot(tangentNormal, normalize(i.lightDir)));\n    // 高光反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向\n    float3 halfA = normalize(normalize(i.viewDir) + normalize(i.lightDir));     // 半角向量\n    fixed3 specularColor = _LightColor0.rgb * _SpecularColor.rgb * pow(max(0, dot(tangentNormal, halfA)), _SpecularNum);\n    // 最终颜色计算\n    fixed3 color = UNITY_LIGHTMODEL_AMBIENT.rgb * albedo + lambertColor + specularColor;\n\n    return fixed4(color.rgb, 1);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241102213331-8ptz4k7","Type":"NodeParagraph","Properties":{"id":"20241102213331-8ptz4k7","updated":"20241102213331"},"Children":[{"Type":"NodeText","Data":"效果如下（左侧方块的凹凸系数为1，右侧方块的凹凸系数为0.3）："}]},{"ID":"20241102213331-q1n1vei","Type":"NodeParagraph","Properties":{"id":"20241102213331-q1n1vei","updated":"20241102213331"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241102213003-uae7vpf.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241102213331-9bkqkqh","Type":"NodeParagraph","Properties":{"id":"20241102213331-9bkqkqh","updated":"20241102213331"},"Children":[{"Type":"NodeText","Data":"可见，现在的凹凸系数可以在不影响光照的情况下，改变模型凹凸感了"}]},{"ID":"20241104090714-xnr570a","Type":"NodeParagraph","Properties":{"id":"20241104090714-xnr570a","updated":"20241104090733"},"Children":[{"Type":"NodeText","Data":"修改后的完整 Shader 代码为："}]},{"ID":"20241104090734-xkwe1v6","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241104090734-xkwe1v6","style":"line-height: 22px;","updated":"20241104090749"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"Shader \"TeachShader/Lesson51\"\n{\n    Properties\n    {\n        _MainColor(\"MainColor\", Color) = (1, 1, 1, 1)\n        _MainTex(\"MainTex\", 2D) = \"\"{}\n        _BumpMap(\"BumpMap\", 2D) = \"\"{}\n        _BumpScale(\"BumpScale\", Range(0, 1)) = 1\n        _SpecularColor(\"SpecularColor\", Color) = (1, 1, 1, 1)\n        _SpecularNum(\"SpecularNum\", Range(0, 20)) = 18\n    }\n    SubShader\n    {\n        Pass\n        {\n            Tags { \"LightMode\" = \"ForwardBase\" }\n\n            CGPROGRAM\n            #pragma vertex vert\n            #pragma fragment frag\n\n            #include \"UnityCG.cginc\"\n            #include \"Lighting.cginc\"\n\n            struct v2f\n            {\n                float4 pos: SV_POSITION;\n                //float2 uvTex: TEXCOORD0;\n                //float2 uvBump: TEXCOORD1; //可以使用两个float2来分别存储主要纹理的uv和法线纹理的uv\n                float4 uv: TEXCOORD0;       //可以使用一个float4来同时存储主要纹理的uv（xy存储）和法线纹理的uv（zw存储）\n                float3 lightDir: TEXCOORD1; //相对于切线空间下的光的方向\n                float3 viewDir: TEXCOORD2;  //相对于切线空间下的视角方向\n            };\n\n            float4 _MainColor;      //漫反射颜色\n            sampler2D _MainTex;     //颜色纹理\n            float4 _MainTex_ST;     //颜色纹理的缩放和平移\n            sampler2D _BumpMap;     //法线纹理\n            float4 _BumpMap_ST;     //法线纹理的缩放和平移\n            float _BumpScale;       //凹凸程度\n            float4 _SpecularColor;  //高光颜色\n            fixed _SpecularNum;     //光泽度\n\n            v2f vert (appdata_full v)\n            {\n                v2f data;\n            \n                data.pos = UnityObjectToClipPos(v.vertex);  //计算裁剪空间下顶点坐标\n                // 分别计算主纹理和法线纹理的缩放平移\n                data.uv.xy = v.texcoord.xy * _MainTex_ST.xy + _MainTex_ST.zw;\n                data.uv.zw = v.texcoord.xy * _BumpMap_ST.xy + _BumpMap_ST.zw;\n\n                // 计算副切线\n                float3 binormal = cross(normalize(v.tangent), normalize(v.normal)) * v.tangent.w;\n                // 得到模型空间到切线空间的转换矩阵\n                float3x3 rotation = float3x3(\n                    v.tangent.xyz,  //切线\n                    binormal,       //副切线\n                    v.normal        //法线\n                );\n            \n                data.lightDir = mul(rotation, ObjSpaceLightDir(v.vertex));   // 切线空间下的光的方向\n                data.viewDir = mul(rotation, ObjSpaceViewDir(v.vertex));    // 切线空间下的视角方向\n\n                return data;\n            }\n\n            fixed4 frag (v2f i) : SV_Target\n            {\n                float4 packedNormal = tex2D(_BumpMap, i.uv.zw);     // 获取法线纹理的颜色数据\n                float3 tangentNormal = UnpackNormal(packedNormal);  // 将颜色数据逆运算并解压缩，得到切线空间下法线数据\n                // 将法线数据的xy乘以凹凸系数，根据xy修正z，避免凹凸系数影响光照亮度\n                tangentNormal.xy *= _BumpScale;                 \n                tangentNormal.z = sqrt(1.0 - saturate(dot(tangentNormal.xy, tangentNormal.xy)));\n\n                // 计算带纹理颜色的BlinnPhong光照计算，这里使用已经计算好的切线数据\n                fixed3 albedo = tex2D(_MainTex, i.uv.xy).rgb * _MainColor.rgb;  // 反射率\n\n                // 漫反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向，注意！这里的 tangentNormal 无需归一化\n                fixed3 lambertColor = _LightColor0.rgb * albedo.rgb * max(0, dot(tangentNormal, normalize(i.lightDir)));\n                // 高光反射光照计算：这里需要使用已经计算完毕的切线数据和光照方向\n                float3 halfA = normalize(normalize(i.viewDir) + normalize(i.lightDir));     // 半角向量\n                fixed3 specularColor = _LightColor0.rgb * _SpecularColor.rgb * pow(max(0, dot(tangentNormal, halfA)), _SpecularNum);\n                // 最终颜色计算\n                fixed3 color = UNITY_LIGHTMODEL_AMBIENT.rgb * albedo + lambertColor + specularColor;\n\n                return fixed4(color.rgb, 1);\n            }\n            ENDCG\n        }\n    }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}