{"ID":"20241128121859-h6voymk","Spec":"1","Type":"NodeDocument","Properties":{"id":"20241128121859-h6voymk","title":"US3S5L4——点光源衰减计算","type":"doc","updated":"20241128124259"},"Children":[{"ID":"20241128121859-dlhkioj","Type":"NodeBlockquote","Properties":{"id":"20241128121859-dlhkioj","updated":"20241128122151"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241128122058-mtha2r0","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241128122058-mtha2r0","updated":"20241128122151"},"Children":[{"Type":"NodeText","Data":"知识回顾"}]},{"ID":"20241128122104-j1u6nj0","Type":"NodeParagraph","Properties":{"id":"20241128122104-j1u6nj0","updated":"20241128122146"},"Children":[{"Type":"NodeText","Data":"在Shader中进行光照衰减处理时，我们是通过从纹理中取出衰减数据\n不使用灯光遮罩时，从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTexture0"},{"Type":"NodeText","Data":"​ 纹理中获取，使用时，从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTextureB0"},{"Type":"NodeText","Data":"​ 纹理中获取\n在纹理采样之前，我们需要将顶点坐标从世界空间中转换到光源空间中，变换矩阵为："}]},{"ID":"20241128122146-ool74ab","Type":"NodeList","ListData":{},"Properties":{"id":"20241128122146-ool74ab","updated":"20241128122151"},"Children":[{"ID":"20241128122146-rg4fkrs","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128122146-rg4fkrs","updated":"20241128122151"},"Children":[{"ID":"20241128122146-dmz0wu8","Type":"NodeParagraph","Properties":{"id":"20241128122146-dmz0wu8","updated":"20241128122151"},"Children":[{"Type":"NodeText","Data":"老版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightMatrix0"},{"Type":"NodeText","Data":"​\n"}]}]},{"ID":"20241128122147-7ykci9r","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128122147-7ykci9r","updated":"20241128122149"},"Children":[{"ID":"20241128122147-jac2l3o","Type":"NodeParagraph","Properties":{"id":"20241128122147-jac2l3o","updated":"20241128122149"},"Children":[{"Type":"NodeText","Data":"新版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"unity_WorldToLight"},{"Type":"NodeText","Data":"​"}]}]}]}]},{"ID":"20241128122153-aybvg5z","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20241128122153-aybvg5z","updated":"20241128124259"},"Children":[{"Type":"NodeText","Data":"点光源衰减计算"}]},{"ID":"20241128122200-z04jk86","Type":"NodeBlockquote","Properties":{"id":"20241128122200-z04jk86","style":"background-color: var(--b3-card-warning-background); color: var(--b3-card-warning-color); --b3-parent-background: var(--b3-card-warning-background);","updated":"20241128122240"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241128122240-rs1t43c","Type":"NodeParagraph","Properties":{"id":"20241128122240-rs1t43c","updated":"20241128122240"},"Children":[{"Type":"NodeText","Data":"注意：一般点光源我们不会为其添加 cookie 光照遮罩，一般想要使用光照遮罩都会在聚光灯中使用，因此我们不用考虑 cookie 纹理的问题"}]}]},{"ID":"20241128122218-fyethjt","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241128122218-fyethjt","updated":"20241128124259"},"Children":[{"ID":"20241128122218-fft3npj","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241128122218-fft3npj","updated":"20241128122218"},"Children":[{"ID":"20241128122218-m74yrdk","Type":"NodeParagraph","Properties":{"id":"20241128122218-m74yrdk","updated":"20241128122218"},"Children":[{"Type":"NodeText","Data":"将顶点从世界空间转换到光源空间\n"}]},{"ID":"20241128122300-q3bhql3","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241128122300-q3bhql3","updated":"20241128122307"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"float3 lightCoord = mul(unity_WorldToLight, float4(worldPos, 1)).xyz;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241128122253-gsuvp49","Type":"NodeParagraph","Properties":{"id":"20241128122253-gsuvp49","updated":"20241128122651"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"lightCoord"},{"Type":"NodeText","Data":"​ 是光源坐标系下顶点根据光源的范围 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"range"},{"Type":"NodeText","Data":"​ 规范化后的坐标，相当于是一个模长为 0"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"1 之间的向量\n也就是说，无论点光源的范围多大，在光源坐标系下规范化后，范围都是 -1"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"1 ，而光源坐标系内的顶点坐标就在其中，因此模长就在 0"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"1 之间"}]},{"ID":"20241128123204-w6eijyx","Type":"NodeParagraph","Properties":{"id":"20241128123204-w6eijyx","updated":"20241128123204"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Properties":{"style":"width: 226px;"},"Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241128123204-482js54.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"width: 226px;\"}"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20241128122218-2jze78a","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241128122218-2jze78a","updated":"20241128124259"},"Children":[{"ID":"20241128122218-jh3n5wo","Type":"NodeParagraph","Properties":{"id":"20241128122218-jh3n5wo","updated":"20241128122334"},"Children":[{"Type":"NodeText","Data":"利用该光源空间下的坐标来计算离光源的距离，并利用距离参数，从光源纹理中采样\n"}]},{"ID":"20241128122340-msm0c6z","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241128122340-msm0c6z","updated":"20241128123255"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"fixed atten = tex2D(_LightTexture0, dot(lightCoord, lightCoord).xx).UNITY_ATTEN_CHANNEL;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241128123521-ekfjjsw","Type":"NodeParagraph","Properties":{"id":"20241128123521-ekfjjsw","updated":"20241128123751"},"Children":[{"Type":"NodeText","Data":"这里的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UNITY_ATTEN_CHANNEL"},{"Type":"NodeText","Data":"​ 是一个宏，由于不同平台上，纹理的光源衰减值分量不一定是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"r"},{"Type":"NodeText","Data":"​ 分量，也有可能是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"g"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"b"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"a"},{"Type":"NodeText","Data":"​\n使用这个宏可以让 Unity 在不同平台上做对应的替换，替换为正确的分量，避免出现错误"}]},{"ID":"20241128123236-4w64wb5","Type":"NodeParagraph","Properties":{"id":"20241128123236-4w64wb5","updated":"20241128123807"},"Children":[{"Type":"NodeText","Data":"在 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"dot(LightCoord, LightCoord).xx"},{"Type":"NodeText","Data":"​ 中："}]},{"ID":"20241128123325-r1bkegx","Type":"NodeList","ListData":{},"Properties":{"id":"20241128123325-r1bkegx","updated":"20241128124004"},"Children":[{"ID":"20241128123353-y2xkcb0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128123353-y2xkcb0","updated":"20241128123353"},"Children":[{"ID":"20241128123353-wqrbz5u","Type":"NodeParagraph","Properties":{"id":"20241128123353-wqrbz5u","updated":"20241128123904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"dot(LightCoord, LightCoord)"},{"Type":"NodeText","Data":"​ 是为了通过点乘得到结果 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"x^2 + y^2 + z^2 = distance^2(离光源距离)"},{"Type":"NodeText","Data":"，也就是离光源的平方距离"}]}]},{"ID":"20241128123353-b0j44n4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128123353-b0j44n4","updated":"20241128124004"},"Children":[{"ID":"20241128123353-hfahmu7","Type":"NodeParagraph","Properties":{"id":"20241128123353-hfahmu7","updated":"20241128123934"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"xx"},{"Type":"NodeText","Data":"​ 是一种特殊写法，目的是构建一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"float2"},{"Type":"NodeText","Data":"​ 代表 uv 坐标"}]},{"ID":"20241128123944-dnrjv4b","Type":"NodeParagraph","Properties":{"id":"20241128123944-dnrjv4b","updated":"20241128124004"},"Children":[{"Type":"NodeText","Data":"这里的 uv 坐标 相当于是 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"(distance^2, distance^2)"},{"Type":"NodeText","Data":"\n"}]}]}]},{"ID":"20241128123349-8i3z0hq","Type":"NodeParagraph","Properties":{"id":"20241128123349-8i3z0hq","updated":"20241128124111"},"Children":[{"Type":"NodeText","Data":"用 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"distance^2"},{"Type":"NodeText","Data":" 做 uv 坐标，而不是 "},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"distance"}]},{"ID":"20241128124017-41576ok","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241128124017-41576ok","updated":"20241128124259"},"Children":[{"ID":"20241128124017-ike6s7o","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241128124017-ike6s7o","updated":"20241128124017"},"Children":[{"ID":"20241128124017-nvx5t75","Type":"NodeParagraph","Properties":{"id":"20241128124017-nvx5t75","updated":"20241128124017"},"Children":[{"Type":"NodeText","Data":"为了避免开平方带来性能消耗"}]}]},{"ID":"20241128124017-r14vja8","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241128124017-r14vja8","updated":"20241128124259"},"Children":[{"ID":"20241128124017-v59twfo","Type":"NodeParagraph","Properties":{"id":"20241128124017-v59twfo","updated":"20241128124017"},"Children":[{"Type":"NodeText","Data":"采用这种平方衰减更符合现实世界中光照的特性\n"}]},{"ID":"20241128124020-pwjmuhh","Type":"NodeParagraph","Properties":{"id":"20241128124020-pwjmuhh","updated":"20241128124259"},"Children":[{"Type":"NodeText","Data":"因为人眼对亮部不敏感，而对暗部敏感，这样我们就可以将 衰减值的精度 集中在比较远的地方\n"},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"distance"},{"Type":"NodeText","Data":" 是 0.5 时，"},{"Type":"NodeTextMark","TextMarkType":"inline-math","TextMarkInlineMathContent":"distance^2"},{"Type":"NodeText","Data":" 是 0.25，这样 LUT 查找表中大部分值都会留给比较远的部分，或者说，将暗部的范围拉长"}]}]}]}]}]}]}