{"ID":"20241126125000-2rtu98e","Spec":"1","Type":"NodeDocument","Properties":{"id":"20241126125000-2rtu98e","title":"US3S5L3——光照衰减","type":"doc","updated":"20241128125256"},"Children":[{"ID":"20241128124408-1k1tynj","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241128124408-1k1tynj","updated":"20241128125028"},"Children":[{"Type":"NodeText","Data":"本章代码关键字"}]},{"ID":"20241128124418-dnqvpsf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241128124418-dnqvpsf","updated":"20241128125028"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"_LightTexture0\t\t\t//不使用灯光遮罩时，光照衰减数据的纹理\n_LightTextureB0\t\t\t//使用灯光遮罩时，光照衰减数据的纹理\n_LightMatrix0\t\t\t//旧版本的顶点坐标系转光源坐标系矩阵\nunity_WorldToLight\t\t//新版本的顶点坐标系转光源坐标系矩阵\nUNITY_ATTEN_CHANNEL\t\t//对光照衰减纹理使用tex2D得到颜色数据后，取出光照衰减值对应的分量的宏\n// 从光照衰减纹理内取出光照衰减值的写法，其中uv坐标由不同光源决定uv坐标如何计算\ntex2D(_LightTexture0, 对应纹理uv坐标).UNITY_ATTEN_CHANNEL\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241126125000-65647d4","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20241126125000-65647d4","updated":"20241128125256"},"Children":[{"Type":"NodeText","Data":"光照衰减"}]},{"ID":"20241126125022-wje6omx","Type":"NodeParagraph","Properties":{"id":"20241126125022-wje6omx","updated":"20241128121351"},"Children":[{"Type":"NodeText","Data":"光照衰减通常指的是在渲染过程中考虑光线在空间中传播时的减弱效应，\n比如："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"任何光源的光照亮度会随着物体离光源的距离增加而迅速衰减"}]},{"ID":"20241126125048-b0h0yrh","Type":"NodeParagraph","Properties":{"id":"20241126125048-b0h0yrh","updated":"20241126125048"},"Children":[{"Type":"NodeText","Data":"一般常见的光照衰减计算方式有"}]},{"ID":"20241126125036-b7946qq","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241126125036-b7946qq","updated":"20241126125038"},"Children":[{"ID":"20241126125036-45w4a2p","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241126125036-45w4a2p","updated":"20241126125038"},"Children":[{"ID":"20241126125036-nibsv75","Type":"NodeParagraph","Properties":{"id":"20241126125036-nibsv75","updated":"20241126125038"},"Children":[{"Type":"NodeText","Data":"线性衰减：光强度与距离成线性关系。即光照衰减与光源到被照射表面的距离成正比。"}]}]},{"ID":"20241126125036-q5am2oc","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241126125036-q5am2oc","updated":"20241126125036"},"Children":[{"ID":"20241126125036-muqm6y2","Type":"NodeParagraph","Properties":{"id":"20241126125036-muqm6y2","updated":"20241126125040"},"Children":[{"Type":"NodeText","Data":"平方衰减：光强度与距离的平方成反比。这种模型更符合现实世界中光照的特性，因为光在空间中的传播过程中通常会遵循平方衰减规律。"}]}]}]},{"ID":"20241126125756-39ivdrg","Type":"NodeParagraph","Properties":{"id":"20241126125756-39ivdrg","updated":"20241128121455"},"Children":[{"Type":"NodeText","Data":"在 Unity Shader 中进行光照衰减处理时，我们一般不手动计算光照衰减，而是通过从纹理中取出衰减数据\n在不使用灯光遮罩时，衰减数据从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTexture0"},{"Type":"NodeText","Data":"​ 纹理中获取，使用灯光遮罩时，从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTextureB0"},{"Type":"NodeText","Data":"​ 纹理中获取\n在对光照衰减纹理采样之前，我们需要将顶点坐标从世界空间中转换到光源空间中，变换矩阵为："}]},{"ID":"20241126125829-y6xnxkl","Type":"NodeList","ListData":{},"Properties":{"id":"20241126125829-y6xnxkl","updated":"20241126125834"},"Children":[{"ID":"20241126125830-vipud53","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125830-vipud53","updated":"20241126125834"},"Children":[{"ID":"20241126125830-kp6gbom","Type":"NodeParagraph","Properties":{"id":"20241126125830-kp6gbom","updated":"20241126125834"},"Children":[{"Type":"NodeText","Data":"老版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightMatrix0"},{"Type":"NodeText","Data":"​\n"}]}]},{"ID":"20241126125831-l5pbda8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125831-l5pbda8","updated":"20241126125833"},"Children":[{"ID":"20241126125831-3ctv7h6","Type":"NodeParagraph","Properties":{"id":"20241126125831-3ctv7h6","updated":"20241126125833"},"Children":[{"Type":"NodeText","Data":"新版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"unity_WorldToLight"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20241126125101-k31q18g","Type":"NodeHeading","HeadingLevel":2,"Properties":{"alias":"_LightTextureB0","id":"20241126125101-k31q18g","name":"_LightTexture0","updated":"20241128125256"},"Children":[{"Type":"NodeText","Data":"Unity 中的光照衰减"}]},{"ID":"20241126125113-k6rn7ij","Type":"NodeParagraph","Properties":{"id":"20241126125113-k6rn7ij","updated":"20241128121647"},"Children":[{"Type":"NodeText","Data":"Unity 中为了提升性能，我们一般不会直接通过数学公式计算光照衰减\n而是使用一张纹理作为查找表（LUT, lookup table），在片元着色器中计算逐像素光照的 衰减\nUnity Shader 中有一个内置的纹理类型的变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTexture0"},{"Type":"NodeText","Data":"​，该纹理中存储了衰减值相关的数据，如下图"}]},{"ID":"20241128121641-03l6l40","Type":"NodeParagraph","Properties":{"id":"20241128121641-03l6l40","updated":"20241128121641"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeImage","Data":"span","Children":[{"Type":"NodeBang"},{"Type":"NodeOpenBracket"},{"Type":"NodeLinkText","Data":"image"},{"Type":"NodeCloseBracket"},{"Type":"NodeOpenParen"},{"Type":"NodeLinkDest","Data":"assets/image-20241128121641-blrx873.png"},{"Type":"NodeCloseParen"}]},{"Type":"NodeText","Data":"​"}]},{"ID":"20241126125142-uisswlz","Type":"NodeParagraph","Properties":{"id":"20241126125142-uisswlz","updated":"20241126125329"},"Children":[{"Type":"NodeText","Data":"Unity 内部预先就计算好了相关数据，并存入到该纹理中，避免重复计算，提升性能表现\n其中，它的对角线上的纹理颜色值，表明了光源空间中不同位置的点对应的衰减值"}]},{"ID":"20241126125335-9ev8lmc","Type":"NodeParagraph","Properties":{"id":"20241126125335-9ev8lmc","updated":"20241126125338"},"Children":[{"Type":"NodeText","Data":"纹理中的对角线"}]},{"ID":"20241126125338-a17bch9","Type":"NodeList","ListData":{},"Properties":{"id":"20241126125338-a17bch9","updated":"20241126125338"},"Children":[{"ID":"20241126125338-pn97j02","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125338-pn97j02","updated":"20241126125338"},"Children":[{"ID":"20241126125338-n6dxyxi","Type":"NodeParagraph","Properties":{"id":"20241126125338-n6dxyxi","updated":"20241126125338"},"Children":[{"Type":"NodeText","Data":"起点 (0,0) 位置，表示和光源重合的点的衰减值\n"}]}]},{"ID":"20241126125338-eda5rep","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125338-eda5rep","updated":"20241126125338"},"Children":[{"ID":"20241126125338-xid4aok","Type":"NodeParagraph","Properties":{"id":"20241126125338-xid4aok","updated":"20241126125338"},"Children":[{"Type":"NodeText","Data":"终点 (1,1) 位置，表示在光源空间中离光源距离最远的点的衰减值"}]}]}]},{"ID":"20241126125323-xz77134","Type":"NodeParagraph","Properties":{"id":"20241126125323-xz77134","updated":"20241126125323"},"Children":[{"Type":"NodeText","Data":"一般我们直接从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTexture0"},{"Type":"NodeText","Data":"​ 中进行纹理采样后，利用其中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UNITY_ATTEN_CHANNEL"},{"Type":"NodeText","Data":"​ 宏来得到衰减值所在的分量"}]},{"ID":"20241128124359-zyhepdt","Type":"NodeParagraph","Properties":{"id":"20241128124359-zyhepdt","updated":"20241128124839"},"Children":[{"Type":"NodeText","Data":"这里的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UNITY_ATTEN_CHANNEL"},{"Type":"NodeText","Data":"​ 是一个宏，由于不同平台上，纹理的光源衰减值分量不一定是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"r"},{"Type":"NodeText","Data":"​ 分量，也有可能是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"g"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"b"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"a"},{"Type":"NodeText","Data":"​\n使用这个宏可以让 Unity 在不同平台上做对应的替换，替换为正确的分量，避免出现错误"}]},{"ID":"20241126125256-b311mqn","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241126125256-b311mqn","updated":"20241126125307"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"tex2D(_LightTexture0, 对应纹理uv坐标).UNITY_ATTEN_CHANNEL\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241128125135-43jjacg","Type":"NodeParagraph","Properties":{"id":"20241128125135-43jjacg","updated":"20241128125256"},"Children":[{"Type":"NodeText","Data":"不同光源的 uv 坐标计算方法不同，详见："}]},{"ID":"20241128125154-9xdp19v","Type":"NodeList","ListData":{},"Properties":{"id":"20241128125154-9xdp19v","updated":"20241128125236"},"Children":[{"ID":"20241128125155-ptyevpq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128125155-ptyevpq","updated":"20241128125226"},"Children":[{"ID":"20241128125155-y5w6hwz","Type":"NodeParagraph","Properties":{"id":"20241128125155-y5w6hwz","updated":"20241128125226"},"Children":[{"Type":"NodeText","Data":"点光源："},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20241128121859-h6voymk","TextMarkBlockRefSubtype":"d","TextMarkTextContent":"US3S5L4——点光源衰减计算"}]}]},{"ID":"20241128125158-1kdcur4","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241128125158-1kdcur4","updated":"20241128125236"},"Children":[{"ID":"20241128125158-seip5nj","Type":"NodeParagraph","Properties":{"id":"20241128125158-seip5nj","updated":"20241128125236"},"Children":[{"Type":"NodeText","Data":"聚光灯："},{"Type":"NodeTextMark","TextMarkType":"block-ref","TextMarkBlockRefID":"20241128125206-i9tmsjl","TextMarkBlockRefSubtype":"d","TextMarkTextContent":"US3S5L5——聚光灯衰减计算"}]}]}]},{"ID":"20241126125235-sd8ajib","Type":"NodeBlockquote","Properties":{"id":"20241126125235-sd8ajib","style":"background-color: var(--b3-card-warning-background); color: var(--b3-card-warning-color); --b3-parent-background: var(--b3-card-warning-background);","updated":"20241126125534"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241126125510-skmyg3h","Type":"NodeParagraph","Properties":{"id":"20241126125510-skmyg3h","updated":"20241126125534"},"Children":[{"Type":"NodeText","Data":"注意：如果光源存在 "},{"Type":"NodeTextMark","Properties":{"style":"background-color: var(--b3-font-background6);"},"TextMarkType":"code block-ref text","TextMarkBlockRefID":"20240321164447-rxtjarn","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"cookie"},{"Type":"NodeKramdownSpanIAL","Data":"{: style=\"background-color: var(--b3-font-background6);\"}"},{"Type":"NodeText","Data":"​，也就是灯光遮罩，那么衰减查找纹理便是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTextureB0"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20241126125516-jjo122v","Type":"NodeHeading","HeadingLevel":2,"Properties":{"alias":"_LightMatrix0","id":"20241126125516-jjo122v","name":"unity_WorldToLight","updated":"20241126125753"},"Children":[{"Type":"NodeText","Data":"光源空间变换矩阵"}]},{"ID":"20241126125625-5ina6q2","Type":"NodeParagraph","Properties":{"id":"20241126125625-5ina6q2","updated":"20241126125711"},"Children":[{"Type":"NodeText","Data":"Unity Shader 中内置的 光源空间变换矩阵，是用于将世界空间下的位置转换到光源空间下（光源位置为原点的坐标系）的"}]},{"ID":"20241126125647-vnn7crd","Type":"NodeList","ListData":{},"Properties":{"id":"20241126125647-vnn7crd","updated":"20241126125700"},"Children":[{"ID":"20241126125647-f37fgzk","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125647-f37fgzk","updated":"20241126125658"},"Children":[{"ID":"20241126125647-d68wvi7","Type":"NodeParagraph","Properties":{"id":"20241126125647-d68wvi7","updated":"20241126125658"},"Children":[{"Type":"NodeText","Data":"老版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightMatrix0"},{"Type":"NodeText","Data":"​\n"}]}]},{"ID":"20241126125648-nqgdlq0","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241126125648-nqgdlq0","updated":"20241126125700"},"Children":[{"ID":"20241126125648-gyt9otp","Type":"NodeParagraph","Properties":{"id":"20241126125648-gyt9otp","updated":"20241126125700"},"Children":[{"Type":"NodeText","Data":"新版本："},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"unity_WorldToLight"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20241126125643-msut3xu","Type":"NodeParagraph","Properties":{"id":"20241126125643-msut3xu","updated":"20241126125724"},"Children":[{"Type":"NodeText","Data":"由于我们需要从 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightTexture0"},{"Type":"NodeText","Data":"​ 光照纹理中取出对应的衰减数据，因此我们需要将顶点位置从世界空间中转换到光源空间中\n然后再来从其中取得衰减数据，我们可以通过矩阵运算将世界空间下的点转换到光源空间下\n"}]},{"ID":"20241126125725-zc97hfg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241126125725-zc97hfg","updated":"20241126125729"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"mul(unity_WorldToLight, float4(worldPos, 1));\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241126125753-sv0hiuz","Type":"NodeParagraph","Properties":{"id":"20241126125753-sv0hiuz","updated":"20241126125753"}}]}