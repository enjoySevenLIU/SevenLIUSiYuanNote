{"ID":"20241123165740-670iqoh","Spec":"1","Type":"NodeDocument","Properties":{"id":"20241123165740-670iqoh","title":"US3S4L4——延迟渲染路径","type":"doc","updated":"20250318131534"},"Children":[{"ID":"20241123165844-55p3o9i","Type":"NodeHeading","HeadingLevel":1,"Properties":{"id":"20241123165844-55p3o9i","updated":"20250318131524"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径"}]},{"ID":"20241123165859-apsu3nx","Type":"NodeParagraph","Properties":{"id":"20241123165859-apsu3nx","updated":"20241123170148"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"对光照的数量没有任何限制，并且所有灯光都可以采用逐像素渲染。"},{"Type":"NodeText","Data":"\n理论上来说，即使场景中有成百上千个实时灯光，依然可以保持比较流畅的渲染帧率。\n"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"它支持法线纹理、阴影等等效果的处理；但是它不能处理半透明物体，并且不支持真正的抗锯齿。"},{"Type":"NodeText","Data":"这些不支持的内容会自动使用前向渲染路径。"}]},{"ID":"20241123172311-c9q7e9h","Type":"NodeList","ListData":{"Typ":1},"Properties":{"id":"20241123172311-c9q7e9h","updated":"20250318131518"},"Children":[{"ID":"20241123172321-5xmtzey","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"MS4=","Num":1},"Properties":{"id":"20241123172321-5xmtzey","updated":"20250318131453"},"Children":[{"ID":"20241123172321-hc5upog","Type":"NodeParagraph","Properties":{"id":"20241123172321-hc5upog","updated":"20241123172330"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径处理光照的方式"}]},{"ID":"20241123172330-retq8ud","Type":"NodeParagraph","Properties":{"id":"20241123172330-retq8ud","updated":"20250318131453"},"Children":[{"Type":"NodeText","Data":"对光照的数量没有任何限制，并且所有灯光都可以采用逐像素渲染，它不能处理半透明物体，并且不支持真正的抗锯齿"}]}]},{"ID":"20241123172323-6fpgnvt","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"Mi4=","Num":2},"Properties":{"id":"20241123172323-6fpgnvt","updated":"20250318131518"},"Children":[{"ID":"20241123172323-ocb3dgj","Type":"NodeParagraph","Properties":{"id":"20241123172323-ocb3dgj","updated":"20241123172323"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径在哪里进行光照计算\n"}]},{"ID":"20241123172338-x40pdah","Type":"NodeList","ListData":{},"Properties":{"id":"20241123172338-x40pdah","updated":"20250318131518"},"Children":[{"ID":"20241123172339-xj7fu8w","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241123172339-xj7fu8w","updated":"20250318131518"},"Children":[{"ID":"20241123172339-avvx5lv","Type":"NodeParagraph","Properties":{"id":"20241123172339-avvx5lv","updated":"20250318131518"},"Children":[{"Type":"NodeText","Data":"第一个 Pass：主要判断哪些片元可见，并且将可见片元的相关信息存储到 G 缓冲区中（对于每个物体，该Pass只会执行一次，通常无需我们自己实现）"}]}]},{"ID":"20241123172340-r2vgm51","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241123172340-r2vgm51","updated":"20250318131501"},"Children":[{"ID":"20241123172340-fai7ytu","Type":"NodeParagraph","Properties":{"id":"20241123172340-fai7ytu","updated":"20250318131501"},"Children":[{"Type":"NodeText","Data":"第二个 Pass：利用G缓冲区中各个片元的相关信息进行真正的相关计算，最终将颜色写入颜色缓冲区"}]}]}]}]},{"ID":"20241123172326-a5thrpc","Type":"NodeListItem","ListData":{"Typ":1,"Delimiter":46,"Marker":"My4=","Num":3},"Properties":{"id":"20241123172326-a5thrpc","updated":"20250318131515"},"Children":[{"ID":"20241123172326-4cyzsil","Type":"NodeParagraph","Properties":{"id":"20241123172326-4cyzsil","updated":"20241123172326"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径的内置光照变量\n"}]},{"ID":"20241123172412-9j1lvaq","Type":"NodeParagraph","Properties":{"id":"20241123172412-9j1lvaq","updated":"20250318131515"},"Children":[{"Type":"NodeText","Data":"Unity 会自动填充自定义变量 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D _CameraGBufferTexture0~4"},{"Type":"NodeText","Data":"​，其中存储的就是 G 缓冲区中的数据，我们可以通过他们获取数据来进行逻辑处理"}]}]}]},{"ID":"20241123165740-rq7953u","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241123165740-rq7953u","updated":"20250318131524"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径处理光照的方式"}]},{"ID":"20241123165914-0ezcr1i","Type":"NodeParagraph","Properties":{"id":"20241123165914-0ezcr1i","updated":"20250318131524"},"Children":[{"Type":"NodeText","Data":"延迟渲染的效率不依赖于场景的复杂度，而是和我们使用的屏幕空间的大小有关。\n这是因为延迟渲染路径中除了使用颜色缓冲和深度缓冲外，还会利用一个叫做 G 缓存的额外缓存区，\n它会存储我们关心的表面（通常是离摄像机最近的表面）的其他信息，比如表面的法线、位置、材质属性等等。\n总之我们需要的信息都存储到缓冲区中，而这些缓冲区可以理解为一张张的 2D 图片，我们实际上是在这些图像空间中进行处理的。"}]},{"ID":"20241123170241-x19pw6h","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241123170241-x19pw6h","updated":"20241123170540"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径在哪里进行光照计算"}]},{"ID":"20241123170101-48wurd8","Type":"NodeParagraph","Properties":{"id":"20241123170101-48wurd8","updated":"20241123170346"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径进行光照计算，还是在 Shader 当中的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​ 渲染通道中进行计算。延迟渲染路径中主要包含两个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​"}]},{"ID":"20241123170253-6w2tic7","Type":"NodeList","ListData":{},"Properties":{"id":"20241123170253-6w2tic7","updated":"20241123170515"},"Children":[{"ID":"20241123170253-dya9ly8","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241123170253-dya9ly8","updated":"20241123170509"},"Children":[{"ID":"20241123170253-ekyig6l","Type":"NodeParagraph","Properties":{"id":"20241123170253-ekyig6l","updated":"20241123170354"},"Children":[{"Type":"NodeText","Data":"第一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​（对于每个物体，该 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​ 只会执行一次，通常无需我们自己实现）\n"}]},{"ID":"20241123170357-7skemmd","Type":"NodeParagraph","Properties":{"id":"20241123170357-7skemmd","updated":"20241123170509"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"主要判断哪些片元可见，并且将可见片元的相关信息存储到 G 缓冲区中"},{"Type":"NodeText","Data":"，比如：表面法线、视角方向、漫反射系数等等数据"}]}]},{"ID":"20241123170254-tdakz8c","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20241123170254-tdakz8c","updated":"20241123170515"},"Children":[{"ID":"20241123170254-mi7gfzy","Type":"NodeParagraph","Properties":{"id":"20241123170254-mi7gfzy","updated":"20241123170515"},"Children":[{"Type":"NodeText","Data":"第二个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​："},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"利用 G 缓冲区中各个片元的相关信息进行真正的相关计算，最终将颜色写入颜色缓冲区"}]},{"ID":"20241123170421-vvqy7nz","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241123170421-vvqy7nz","style":"line-height: 22px;","updated":"20241123170446"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"Pass\n{\n    Tags { \"LightMode\" = \"Deferred\" }\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}]},{"ID":"20241123170302-xp50i2l","Type":"NodeBlockquote","Properties":{"id":"20241123170302-xp50i2l","style":"background-color: var(--b3-card-warning-background); color: var(--b3-card-warning-color);","updated":"20241123170522"},"Children":[{"Type":"NodeBlockquoteMarker","Data":"\u003e"},{"ID":"20241123170522-5pzuo10","Type":"NodeParagraph","Properties":{"id":"20241123170522-5pzuo10","updated":"20241123170522"},"Children":[{"Type":"NodeText","Data":"注意：在第二个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​ 中计算光照时，默认情况下只能用 Unity 内置的标准（Standard）光照模型计算"}]}]},{"ID":"20241123170540-b1iktaz","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20241123170540-b1iktaz","updated":"20250318131534"},"Children":[{"Type":"NodeText","Data":"延迟渲染路径的内置光照变量"}]},{"ID":"20241123170546-knbunau","Type":"NodeParagraph","Properties":{"id":"20241123170546-knbunau","updated":"20241123170605"},"Children":[{"Type":"NodeText","Data":"常用内置光照变量"}]},{"ID":"20241123170606-l3q9wbx","Type":"NodeTable","TableAligns":[0,0,0],"Properties":{"colgroup":"|min-width: 60px;|","id":"20241123170606-l3q9wbx","updated":"20241123173033"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"变量名"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"类型"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"描述"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D _CameraGBufferTexture0"},{"Type":"NodeText","Data":"​；"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D _CameraGBufferTexture1"},{"Type":"NodeText","Data":"​；"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D _CameraGBufferTexture2"},{"Type":"NodeText","Data":"​；"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D _CameraGBufferTexture3"},{"Type":"NodeText","Data":"​；"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeText","Data":"….."},{"Type":"NodeBr","Data":"br"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"sampler2D"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"这些变量是自定义变量，我们一般无需实现延迟渲染路径中的第一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​，"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"G 缓冲中的相关数据 Unity 会帮助我们存储到这些自定义变量中"},{"Type":"NodeText","Data":"，我们可以直接使用他们来参与计算："},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_CameraGBufferTexture0"},{"Type":"NodeText","Data":"​：漫反射颜色 (RGB)，遮挡 (A)。"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_CameraGBufferTexture1"},{"Type":"NodeText","Data":"​：镜面反射颜色 (RGB)，粗糙度 (A)"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_CameraGBufferTexture2"},{"Type":"NodeText","Data":"​：世界空间法线 (RGB)，未使用 (A)。"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_CameraGBufferTexture3"},{"Type":"NodeText","Data":"​：发射 + 光照 + 光照贴图 + 反射探针缓冲区"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_CameraGBufferTexture4"},{"Type":"NodeText","Data":"​：光照遮挡值 (RGBA)"},{"Type":"NodeBr","Data":"br"},{"Type":"NodeText","Data":"….."},{"Type":"NodeBr","Data":"br"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code block-ref","TextMarkBlockRefID":"20240616185553-hqtgl7k","TextMarkBlockRefSubtype":"s","TextMarkTextContent":"_LightColor"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"float4"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"光源颜色（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"#include \u0026quot;UnityDeferredLibrary.cginc\u0026quot;"},{"Type":"NodeText","Data":"​）"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"_LightMatrix0"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"float4x4"},{"Type":"NodeText","Data":"​"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"世界空间到光源空间的变换矩阵（"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"#include \u0026quot;UnityDeferredLibrary.cginc\u0026quot;"},{"Type":"NodeText","Data":"​）"}]}]}]},{"ID":"20241123170710-yalb1ma","Type":"NodeParagraph","Properties":{"id":"20241123170710-yalb1ma","updated":"20241123171431"},"Children":[{"Type":"NodeText","Data":"为了更好的使用上述的自定义变量，需要先引用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnityGBuffer.cginc"},{"Type":"NodeText","Data":"​"}]},{"ID":"20241123171332-i9irr74","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241123171332-i9irr74","style":"line-height: 22px;","updated":"20241123171350"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"#include “UnityGBuffer.cginc”\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241123171408-zytapl3","Type":"NodeParagraph","Properties":{"id":"20241123171408-zytapl3","updated":"20241123172039"},"Children":[{"Type":"NodeText","Data":"假设我们声明了三个自定义的 G 缓冲贴图变量"}]},{"ID":"20241123171456-gbnlwep","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241123171456-gbnlwep","style":"line-height: 22px;","updated":"20241123171532"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"sampler2D _CameraGBufferTexture0;\nsampler2D _CameraGBufferTexture1;\nsampler2D _CameraGBufferTexture2;\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20241123171535-kcy5grb","Type":"NodeParagraph","Properties":{"id":"20241123171535-kcy5grb","updated":"20241123172251"},"Children":[{"Type":"NodeText","Data":"在第一个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​ 后（无需自己声明），这些 G 缓冲贴图变量就会自动被 Unity 存储 G 缓冲相关数据，\n我们便可以在第二个 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Pass"},{"Type":"NodeText","Data":"​ 内对这些数据进行采样，然后将采样数据传入到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnityStandardDataFromGbuffer"},{"Type":"NodeText","Data":"​，\n最终就会得到 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"UnityStandardData"},{"Type":"NodeText","Data":"​，通过这些数据即可进行光照计算"}]},{"ID":"20241123171738-ld7qrw8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20241123171738-ld7qrw8","style":"line-height: 22px;","updated":"20241123172213"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"Yw=="},{"Type":"NodeCodeBlockCode","Data":"half4 gbuffer0 = tex2D(_CameraGBufferTexture0, uv);\nhalf4 gbuffer1 = tex2D(_CameraGBufferTexture1, uv);\nhalf4 gbuffer2 = tex2D(_CameraGBufferTexture2, uv);\nUnityStandardData data = UnityStandardDataFromGbuffer(gbuffer0, gbuffer1, gbuffer2);\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20250318131534-fqcdqx0","Type":"NodeParagraph","Properties":{"id":"20250318131534-fqcdqx0","updated":"20250318131534"}}]}